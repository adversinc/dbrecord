{"version":3,"sources":["../src/MysqlDatabase.js"],"names":["masterConfig","masterDbh","connectionPool","trxContext","createNamespace","MysqlDatabase","config","_config","_db","_createdFromPool","createConnection","_transacted","cb","getConnection","err","dbh","debugSQL","_seq","parseInt","Math","random","on","sequence","console","log","sql","connect","future","return","wait","end","trxDb","destroy","setTimeout","process","exit","query","values","Promise","resolve","reject","res","q","throw","rows","querySync","length","reuseConnection","connectSync","run","set","ex","rollback","commit","release","removeHandlers","removeListener","_closeAndExit","trxDbh","get","createPool"],"mappings":"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","file":"MysqlDatabase.js","sourcesContent":["import Future from 'fibers/future';\r\nimport lodashMerge from 'lodash/merge';\r\nimport mysql from 'mysql';\r\nimport ContextStorage from 'continuation-local-storage';\r\n\r\n/**\r\n * The MySQL connection wrapper which provides the following features:\r\n * - \"master\" db connection factory function\r\n * - sync queries (using Future)\r\n * - async queries (using Promises - not tested yet)\r\n * - nested transactions support (in progress)\r\n * - connection pooling for transaction\r\n * - local context of \"master\" db connection inside the transaction\r\n *\r\n */\r\n\r\nlet masterConfig = {};\r\nlet masterDbh = null;\r\n\r\n// Connection pool\r\n// If connection pool has been set up, MysqlDatabase will pick connections from it\r\nlet connectionPool = null;\r\n\r\n// Local dbh context for transaction. Each transaction generates its own local\r\n// context with its own \"current global\" dbh.\r\n// During the transactions start, the value is populated with a transaction\r\n// dbh, so all upcoming masterDbh() calls return the dbh actual for this transaction.\r\nlet trxContext = ContextStorage.createNamespace('mysql-dbh');\r\n\r\n/**\r\n * The database processing class.\r\n *\r\n * Transaction processing\r\n *\r\n * The problem is that all queries share the same mysql connection. Thus, even\r\n * if we have started the transaction, other queries can intervene within it.\r\n *\r\n * To avoid this, we create a separate connection when calling code starts\r\n * transaction. Then we return the new database handle (\"transacted\") to use,\r\n * and commit/rollback at the end.\r\n *\r\n * var dbh = dbh.beginTransaction(); // new dbh is created here\r\n * ....\r\n * dbh.commit();\r\n */\r\nclass MysqlDatabase {\r\n\t/**\r\n\t * config:\r\n\t * \tuser, password, host - regular mysql connection settings\r\n\t * \treuseConnection - during a transaction start, don't get a new connection\r\n\t * \tdebugSQL - log all SQL queries (debug)\r\n\t * @param config\r\n\t */\r\n\tconstructor(config) {\r\n\t\tthis._config = lodashMerge({}, config);\r\n\r\n\t\tthis._db = null;\r\n\t\tthis._createdFromPool = false;\r\n\t\tif(!connectionPool) {\r\n\t\t\tthis._db = mysql.createConnection(this._config);\r\n\t\t}\r\n\r\n\t\tthis._transacted = 0;\r\n\t}\r\n\r\n\tconnect(cb) {\r\n\t\tif(connectionPool) {\r\n\t\t\tconnectionPool.getConnection((err, dbh) => {\r\n\t\t\t\t// console.log(\"connection taken from pool\");\r\n\t\t\t\tthis._createdFromPool = true;\r\n\t\t\t\tthis._db = dbh;\r\n\r\n\t\t\t\t// SQL logging\r\n\t\t\t\tif(this._config.debugSQL) {\r\n\t\t\t\t\tif(!this._db._seq) {\r\n\t\t\t\t\t\tthis._db._seq = parseInt(Math.random() * 100000);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tthis._db.on('enqueue', function(sequence) {\r\n\t\t\t\t\t\tconsole.log(\"QUERY (\" + this._seq + \"): \", sequence.sql);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(cb) { cb(err); }\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis._db.connect(cb);\r\n\t\t}\r\n\t}\r\n\r\n\tconnectSync() {\r\n\t\tconst future = new Future();\r\n\t\tthis.connect((err) => {\r\n\t\t\tif(err) {\r\n\t\t\t\tthrow err;\r\n\t\t\t}\r\n\r\n\t\t\tfuture.return();\r\n\t\t});\r\n\r\n\t\treturn future.wait();\r\n\t}\r\n\r\n\tdisconnect() {\r\n\t\tthis._db.end();\r\n\t}\r\n\r\n\tcloseAndExit() {\r\n\t\ttrxDb.destroy();\r\n\t\tsetTimeout(() => { process.exit(); }, 500);\r\n\t}\r\n\r\n\tquery(query, values, cb) {\r\n\t\treturn this._db.query(query, values, cb);\r\n\t}\r\n\r\n\tqueryAsync(query, values) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.query(query, values, (err, res) => {\r\n\t\t\t\tresolve(res);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t/**\r\n\t * Runs a select query synchronously and returns the results\r\n\t * @param query - query to run\r\n\t * @param values - values to be passed to query\r\n\t */\r\n\tquerySync(query, values) {\r\n\t\tconst future = new Future();\r\n\r\n\t\t// console.log(\"query\", this._transacted?\"(TRX)\":\"\", query);\r\n\r\n\t\tthis._db.query(query, values, (err, q) => {\r\n\t\t\tif(err) {\r\n\t\t\t\t//throw err;\r\n\t\t\t\tfuture.throw(err);\r\n\t\t\t} else {\r\n\t\t\t\tfuture.return(q);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\treturn future.wait();\r\n\t}\r\n\r\n\t/**\r\n\t * A shortcut function to get a single rows without messing with row arrays\r\n\t *\r\n\t * @param query\r\n\t * @param values\r\n\t * @returns {Object} - the object with selected fields or {} of no rows found\r\n\t */\r\n\tgetRowSync(query, values) {\r\n\t\tconst rows = this.querySync(query, values);\r\n\t\t// It is questionable: should we return {} or null below? Which is easier to use?\r\n\t\t// {} seems to be safer to use, no null.field error will fire\r\n\t\tif(rows.length === 0) { return {}; }\r\n\r\n\t\treturn rows[0];\r\n\t}\r\n\r\n\t/**\r\n\t * Begins the database transaction.\r\n\t *\r\n\t * options:\r\n\t * \treuseConnection - use the same connection (debug)\r\n\t *\r\n\t * @param {Function} cb - the callback to call. Should return 'false' if\r\n\t * \ttransaction should be rolled back\r\n\t */\r\n\texecTransaction(cb) {\r\n\t\t// TODO GG: port the nested trasactions code here\r\n\t\t// Create another connection\r\n\t\t//const trxDb = new MysqlDatabase(mysql.createConnection(Meteor.settings.mysql));\r\n\t\tlet trxDb = null;\r\n\r\n\t\tif(this._transacted > 0 || this._config.reuseConnection) {\r\n\t\t\t// In a nested transaction, don't create a new connection\r\n\t\t\ttrxDb = this;\r\n\t\t} else {\r\n\t\t\ttrxDb = new MysqlDatabase(this._config);\r\n\t\t\ttrxDb._transacted = this._transacted;\r\n\t\t\ttrxDb.connectSync();\r\n\t\t}\r\n\r\n\t\t// Only execute START TRANSACTION for the first-level trx\r\n\t\tif(trxDb._transacted++ === 0) {\r\n\t\t\ttrxDb.querySync(\"START TRANSACTION  /* from trx */\");\r\n\t\t}\r\n\r\n\t\t// console.log(\"before context\");\r\n\t\t// Execute transaction and create a running context for it\r\n\t\ttrxContext.run(() => {\r\n\t\t\ttrxContext.set(\"dbh\", trxDb);\r\n\r\n\t\t\tlet res = false;\r\n\t\t\ttry {\r\n\t\t\t\tres = cb(trxDb);\r\n\t\t\t} catch(ex) {\r\n\t\t\t\ttrxDb.rollback();\r\n\t\t\t\tthrow ex;\r\n\t\t\t}\r\n\r\n\t\t\tif(res === false) {\r\n\t\t\t\ttrxDb.rollback();\r\n\t\t\t} else {\r\n\t\t\t\ttrxDb.commit();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// If we created a new connection, destroy it\r\n\t\tif(trxDb != this) {\r\n\t\t\ttrxDb.destroy();\r\n\t\t}\r\n\r\n\t\treturn trxDb;\r\n\t}\r\n\r\n\t/**\r\n\t * Commits the current database transaction\r\n\t */\r\n\tcommit() {\r\n\t\tif(this._transacted > 0) {\r\n\t\t\tthis._transacted--;\r\n\r\n\t\t\tif(this._transacted === 0) {\r\n\t\t\t\tthis.querySync(\"COMMIT /* from trx */\");\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Rolls back the current database transaction\r\n\t */\r\n\trollback() {\r\n\t\tif(this._transacted > 0) {\r\n\t\t\tthis._transacted--;\r\n\r\n\t\t\tif(this._transacted === 0) {\r\n\t\t\t\tthis.querySync(\"ROLLBACK\");\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tdestroy() {\r\n\t\t// Connections created from pool are to be released, direct connections destroyed\r\n\t\tif(this._createdFromPool) {\r\n\t\t\tthis._db.release();\r\n\t\t} else {\r\n\t\t\tthis._db.destroy();\r\n\t\t}\r\n\r\n\t\tthis.removeHandlers();\r\n\t}\r\n\r\n\tremoveHandlers() {\r\n\t\tprocess.removeListener('SIGTERM', this._closeAndExit);\r\n\t\tprocess.removeListener('SIGINT', this._closeAndExit);\r\n\t}\r\n\r\n\t_closeAndExit() {\r\n\t\tsetTimeout(() => { process.exit(); }, 500);\r\n\t}\r\n\r\n\t/**\r\n\t * The connection configuration for masterDbh\r\n\t * @param config\r\n\t */\r\n\tstatic masterConfig(config) {\r\n\t\tmasterConfig = config;\r\n\t}\r\n\r\n\t/**\r\n\t * The connection factory. Creates a global connection to be used by default\r\n\t */\r\n\tstatic masterDbh() {\r\n\t\t// First try to get the local scope dbh of the current transaction\r\n\t\tconst trxDbh = trxContext.get(\"dbh\");\r\n\t\tif(trxDbh) {\r\n\t\t\treturn trxDbh;\r\n\t\t}\r\n\r\n\t\t// If no global dbh exist, create it\r\n\t\tif(!masterDbh) {\r\n\t\t\tmasterDbh = new MysqlDatabase(masterConfig);\r\n\t\t\tmasterDbh.connectSync();\r\n\t\t}\r\n\r\n\t\treturn masterDbh;\r\n\t}\r\n\r\n\r\n\tstatic masterDbhDestroy() {\r\n\t\tif(masterDbh) {\r\n\t\t\tmasterDbh.destroy();\r\n\t\t\tmasterDbh = null;\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Setup the mysql connection pool. All further connectionswill be\r\n\t * taken from within this pool.\r\n\t *\r\n\t * config:\r\n\t * \tuser, password, host - regular mysql connection settings\r\n\t * \tconnectionLimit - the size of the connection pool. Pool is used only if poolSize > 0\r\n\t * @param config\r\n\t */\r\n\tstatic setupPool(config) {\r\n\t\tthis.masterConfig(config);\r\n\t\tconnectionPool = mysql.createPool(config);\r\n\t}\r\n}\r\n\r\n\r\nexport default MysqlDatabase;\r\n\r\n"]}